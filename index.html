<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="None" />
      <link rel="shortcut icon" href="img/favicon.ico" />
    <title>FASTEL Documentation</title>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Home";
        var mkdocs_page_input_path = "index.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="." class="icon icon-home"> FASTEL Documentation
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href=".">Home</a>
    <ul class="current">
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="background/">Contributions</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href=".">FASTEL Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Home</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="flexible-modeling-and-multitask-learning-using-differentiable-tree-ensembles">Flexible Modeling and Multitask Learning using Differentiable Tree Ensembles</h1>
<p><strong> Authors: Shibal Ibrahim, Hussein Hazimeh, Rahul Mazumder and Paul Theron </strong></p>
<p>This site provides an introduction to FASTEL, a new toolkit for learning differentiable tree ensembles <a href="https://dl.acm.org/doi/pdf/10.1145/3534678.3539412">(2022, Ibrahim, Hazimeh and Mazumder)</a>. An overview of the theory can be foun <a href="background/">here</a> . To dive in, a code tutorial can be found below.</p>
<p>This site provides an introduction to FASTEL (Flexible and Scalable Tree Ensemble Learning), a flexible and scalable toolkit for learning tree ensembles. We introduce a novel, tensor-based formulation for differentiable tree ensembles that allows for efficient training on GPUs.  We extend differentiable tree ensembles to multi-task learning settings by introducing a new regularizer that allows for soft parameter sharing across tasks. Our framework can lead to 100x more compact ensembles and up to 23% improvement in out-of-sample performance, compared to tree ensembles learnt by popular toolkits such as XGBoost. See our paper <a href="https://arxiv.org/abs/2205.09717">Flexible Modeling and Multitask Learning using Differentiable Tree Ensembles</a> appearing in 28th ACM SIGKDD Conference on Knowledge Discovery and Data Mining 2022 for details. An overview of the theory can be found <a href="background/">here</a> . To dive in, a code tutorial can be found below.</p>
<p>All code in the following tutorial, as well as further extensions, can be found on <a href="https://github.com/ShibalIbrahim/FASTEL">Github</a>.</p>
<h1 id="tutorial">Tutorial</h1>
<h2 id="installation">Installation</h2>
<p>FASTEL is written in Tensorflow 2.4. It uses Tensorflow-Probability (0.12) internally (for flexibility in modeling to support zero-inflation, negative binomial regression loss functions). Before installing FASTEL, please make sure that Tensorflow-GPU 2 and Tensorflow-Probability are installed.</p>
<h2 id="support">Support</h2>
<p>The toolkit supports the following features:</p>
<ol>
<li>singletask and multitask regression</li>
<li>missing responses</li>
<li>zero-inflated-poisson</li>
<li>negative binomial regression</li>
<li>GPU training</li>
</ol>
<h2 id="loading-dependencies">Loading Dependencies</h2>
<p>First, we load in all third-party packages. </p>
<pre class="highlight"><code class="language-python">%matplotlib inline
import os
import pandas as pd, numpy as np, s3fs, matplotlib.pyplot as plt
import seaborn as sns
import timeit
import joblib
from copy import deepcopy
import seaborn as sb
import pandas as pd
import time
import pathlib
import argparse</code></pre>
<p>Then, we load in all custom packages. </p>
<pre class="highlight"><code class="language-python">import data_utils
import engine</code></pre>
<h2 id="initialize-parameters">Initialize parameters</h2>
<p>We define all default arguments for the fastel method. </p>
<pre class="highlight"><code class="language-python">
parser = argparse.ArgumentParser(description='Multitask differentiable decision tree ensembles.')

# Data Arguments
parser.add_argument('--load_directory', dest='load_directory',  type=str, default='s3://cortex-mit1003-lmdl-workbucket/public-datasets-processed')
parser.add_argument('--data', dest='data',  type=str, default='atp1d')
parser.add_argument('--seed', dest='seed',  type=int, default=8)
parser.add_argument('--val_size', dest='val_size',  type=float, default=0.2)
parser.add_argument('--test_size', dest='test_size',  type=float, default=0.2)
parser.add_argument('--missing_percentage', dest='missing_percentage',  type=float, default=0.0)

# Model Arguments
parser.add_argument('--trees', dest='trees',  type=int, default=20)
parser.add_argument('--depth', dest='depth',  type=int, default=4)
parser.add_argument('--activation', dest='activation',  type=str, default='sigmoid')
parser.add_argument('--loss', dest='loss',  type=str, default='mse')
parser.add_argument('--architecture', default='shared', type=str) # only matters for ZIP, NB losses.
parser.add_argument('--model_type', default=None, type=str) # 'regularized' or None
parser.add_argument('--alpha', dest='alpha', type=float, default=0.1) # for regularization
parser.add_argument('--power', dest='power', type=float, default=1.0) # for regularization strength along depth

# Algorithm Arguments
parser.add_argument('--epochs', dest='epochs',  type=int, default=200)
parser.add_argument('--batch_size', dest='batch_size',  type=int, default=64)
parser.add_argument('--learning_rate', dest='learning_rate', type=float, default=0.01)
parser.add_argument('--patience', dest='patience',  type=int, default=25)

# Logging Arguments
parser.add_argument('--version', dest='version',  type=int, default=1)
parser.add_argument('--save_directory', dest='save_directory',  type=str, default='./runs/soft_trees/publicdata')

args = parser.parse_args()

# Saving path
path = os.path.join(args.save_directory, args.data, "all-tasks", args.loss, "{}".format(args.version))
os.makedirs(path, exist_ok=True)</code></pre>
<h2 id="data-and-preprocessing">Data and Preprocessing</h2>
<pre class="highlight"><code class="language-python">df_X, df_y, metadata = data_utils.load_multitask_public_data(
    data=args.data,
    path=args.load_directory,
)
data_processed = data_utils.load_processed_multitask_public_data(
    df_X, df_y, metadata,
    'all',
    val_size=args.val_size,
    test_size=args.test_size,
    seed=args.seed,
    missing_percentage=args.missing_percentage,    
)</code></pre>
<h2 id="modeling-with-multitaskengine">Modeling with MultiTaskEngine</h2>
<p>We initialize the multitask engine with the parameters defined above. </p>
<pre class="highlight"><code class="language-python">fastel = engine.MultiTaskTrees(
    data_processed.x_train_processed.shape[1:],
    loss_criteria=args.loss,
    architecture=args.architecture,
    activation=args.activation,
    num_trees=args.trees,
    depth=args.depth,
    num_tasks=data_processed.y_train_processed.shape[1],
    model_type=args.model_type,
    alpha=args.alpha,
    power=args.power,
    batch_size=args.batch_size,
    learning_rate=args.learning_rate,
    epochs=args.epochs,
)

fastel.train(
    data_processed.x_train_processed,
    data_processed.y_train_processed,
    data_processed.w_train,
    data_processed.x_valid_processed,
    data_processed.y_valid_processed,
    data_processed.w_valid
)</code></pre>
<h2 id="evaluation">Evaluation</h2>
<pre class="highlight"><code class="language-python">metrics_valid = fastel.evaluate(data_processed.x_valid_processed, data_processed.y_valid_processed, data_processed.w_valid)
metrics_test = fastel.evaluate(data_processed.x_test_processed, data_processed.y_test_processed, data_processed.w_test)
print("\n============Validation Metrics =================")
print(metrics_valid)
print("\n============Test Metrics =================")
print(metrics_test)</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="background/" class="btn btn-neutral float-right" title="Contributions">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
      <span><a href="background/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme_extra.js" defer></script>
    <script src="js/theme.js" defer></script>
      <script src="javascripts/config.js" defer></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

<!--
MkDocs version : 1.3.1
Build Date UTC : 2022-09-19 03:03:50.873872+00:00
-->
